{% extends "base.html" %} 
{% set active_page = "create-recurring-events" %}
{% block title %}Create recurring events{% endblock title %}
{% block content %}
<div class="row g-5">
  <div class="col-md-3 offset-md-9 text-end">
<button type="button" id="btn-timezone" class=" btn btn-success " data-bs-toggle="modal" data-bs-target="#timezone_modal">
  {% if timezone %}
  Time zone: {{timezone}}
  {% else %}
  Select timezone
  {% endif %}
</button>
</div>
</div>
<div class="row g-5">
  <div class="col-md-12">

    <form id="clear-all" method="POST" action="clear-all" onSubmit="return confirm('Are you sure you wish to clear everything and start over again?');"></form>
    <form id="delete-backup" method="POST" action="delete-backup"></form>
    <form id="delete-rooms" method="POST" action="delete-rooms"></form>
    <form id="events-generator" class="needs-validation" method="POST" action="create-recurring-events" novalidate="">
      {{ form.hidden_tag() }}
      <div class="row g-3">
        <div class="col-md-6">
          <div class="row">
            <div class="col-md-8">
              <h4 class="mb-3">Event details</h4>
            </div>
            <div class="col-md-4 text-end">
              <button type="hidden" class="btn btn-outline-secondary btn-sm" form="clear-all" data-toggle="tooltip" data-placement="top" title="Clear all and start over again"><i class="bi bi-trash me-2"></i>Clear all</button>
            </div>
            </div>
          <div id="custom-fields-wrapper" class="row mb-5">
           

            {% include 'recurring_events_elements/custom-fields.html' %}



            </div>
            <div class="row mb-5">
              <div class="col-sm-12">
                {{ form.details.label(class_='form-label') }}
                {{ form.details() }}
              </div>
            </div>
            
            <div class="row mb-5">
              <div class="col-6">
                {{ form.timestart.label(class_='form-label') }}
                {{ form.timestart() }}
                {% for error in form.timestart.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}    
              </div>
            

              <div class="col-6">
                {{ form.timefinish.label(class_='form-label') }}
                {{ form.timefinish() }}
                {% for error in form.timefinish.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}    
              </div>
            </div>
            
            <div class="row mb-5">
              <div class="col-sm-6">
              <div id="rooms-wrapper">
                {% include 'recurring_events_elements/rooms.html' %}
              </div>
              </div>
              <div class="col-sm-6">
                {{ form.capacity.label(class_='form-label') }}
                {{ form.capacity() }}   
                {% for error in form.capacity.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}            
              </div>
            </div>
          
            <div class="row mb-5">
              <div class="col-sm-12">
                <div class="form-check">
                  {{ form.allow_overbook() }}  
                  {{ form.allow_overbook.label(class_='form-check-label') }}
                </div>
              </div>
            </div>
            <div class="row mb-5">
              <div class="col-sm-12">
                <div class="row">
                  <div class="col-sm-12">
                {{ form.allow_cancellations.label(class_='form-label') }}
                {{ form.allow_cancellations() }}
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-3">
                    {{ form.cancellation_cutoff_number() }} 
                    {% for error in form.cancellation_cutoff_number.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}     
                  </div>
                  <div class="col-sm-5">
                    {{ form.cancellation_cutoff_timeunit() }}
                  </div>
                  <div class="col-sm-4">
                    <small class="text-muted fw-light d-block">before event starts</small>

                  </div>
                </div>  
              </div>
            </div>
            
            <div class="row mb-5">
              <div class="col-sm-6">
                {{ form.min_capacity.label(class_='form-label') }}
                {{ form.min_capacity() }}
                {% for error in form.min_capacity.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}               
              </div>
              <div class="col-sm-6">
                <div class="row">
                  <div class="col-sm-12 mb-2">

                    <div class="form-check">
                      {{ form.send_capacity_email() }}  
                      {{ form.send_capacity_email.label(class_='form-check-label') }}
                    </div>
                </div></div>
                <div class="row">
                  <div class="col-sm-3">
                    {{ form.send_capacity_email_cutoff_number() }} 
                    {% for error in form.send_capacity_email_cutoff_number.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %} 
                  </div>
                  <div class="col-sm-5">
                    {{ form.send_capacity_email_cutoff_timeunit() }} 
                  </div>
                  <div class="col-sm-4">
                    <small class="text-muted fw-light d-block">before event starts</small>

                  </div>
                </div>            
              </div>
            </div>
            <div class="row mb-5">
              <div class="col-sm-12">
                {{ form.normal_cost.label(class_='form-label') }}
                {{ form.normal_cost() }}   
                {% for error in form.normal_cost.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}           
              </div>
            </div>

          
        </div>

        <div class="col-md-5 offset-md-1">
          <div class="row mt-5">
            <div class="col-6">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            Recurrence
            
          </h4>
          </div>
          <div class="col-6 text-end">
            {% set set_recurrence_type = "recurring" %}
            
            {% set set_recurrence_type_text = "Create recurring events" %}
            {% if recurrence_type == "recurring" or recurrence_type == None %}
              {% set set_recurrence_type = "manual" %}
              {% set set_recurrence_type_text = "Select dates manually" %}
            {% endif %}

            <a href="{{ url_for('create_recurring_events', recurrence_type=set_recurrence_type) }}" class="btn btn-sm btn btn-outline-secondary">{{ set_recurrence_type_text }}</a>
              

            </a>
          </div>
          </div>
          <div class="row mb-5">
            <div class="col-6">
              {% if recurrence_type != "manual" %}
                {{ form.datestart.label(class_='form-label')}}
                {{ form.datestart() }}
                {% for error in form.datestart.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}
              {% else %}
                {{ form.manual_dates.label(class_='form-label') }}
                {{ form.manual_dates() }}
                {% for error in form.manual_dates.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}
              {% endif %}
              
              
            </div>
            {% if recurrence_type != "manual" %}
              <div class="col-6">
                {{ form.datefinish.label(class_='form-label') }}
                {{ form.datefinish() }}
                
                  {% for error in form.datefinish.errors %}
                    <small class="text-danger">{{ error }}</small>
                  {% endfor %}
              
                
              </div>
            {% endif %}
        </div>
        {% if recurrence_type != "manual" %}
          <div class="row mb-5">
            <h4 class="d-flex justify-content-between align-items-center mb-3">
              Recurrence pattern
            </h4>
              <div class="control-group">
                {{ form.frequency.label(class_='form-label') }}
                {{ form.frequency() }}
              </div>
            </div>

            <div class="row mb-3">
              <!-- <div class="period-settings" style="display: none" id="daily">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="d_settings"
                    id="d_daily"
                  />
                  <div class="form-check-label" for="d_settings">
                    <span class="d-inline">Every</span>
                    <input
                      id="d_interval_days"
                      name="d_interval_days"
                      type="number"
                      placeholder=""
                      class="form-control d-inline"
                      required=""
                    />
                    <span class="d-inline">day(s)</span>
                  </div>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="d_settings"
                    id="d_weekdays"
                    checked
                  />
                  <label class="form-check-label" for="d_settings">
                    Every weekday
                  </label>
                </div>
              </div> -->

              <div class="col-4">
                <div id="occurrence-number-container" class="d-none control-group">
                  {{ form.occurrence_number.label(class_='form-label') }}
                  {{ form.occurrence_number() }}
                </div>

              </div>
              <div class="col-4">
                <div id="days-of-week-container">
                  {% for value, text in form.days_of_week.choices %}
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            value="{{ value }}"
                            name="days_of_week"
                            id="{{ value }}"
                          />
                          <label class="form-check-label" for="{{ value }}">{{ text }}</label>
                        </div>
                    {% endfor %}
              </div>
              {% for error in form.days_of_week.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}
            </div>

              <div class="col-4">
              <div id="interval-container">
                {{ form.interval.label(class_='d-inline') }}
                {{ form.interval() }}  
                <span class="d-inline" id="interval-text">week(s)</span>
              </div>
              {% for error in form.interval.errors %}
                  <small class="text-danger">{{ error }}</small>
                {% endfor %}
            </div>
            
          </div>
          {% endif %}
          <div class="row">
          {{ form.submit() }} 
        </div>
           
        <div class="message">

          <div class="alert fade show mt-3" role="alert">
  
          </div>
  
           </div>

        </div>
      </div>

      <hr class="my-4" />

      
    </form>
   
  </div>
</div>

<div id="event-sets">
  {% include 'recurring_events_elements/event-sets.html' %}
</div>

<button
        type="button"
        class="btn btn-danger btn-floating btn-lg btn-fixed"
        id="btn-back-to-top"
        >
  <i class="bi bi-chevron-up"></i>
</button>


      <div class="modal fade" id="timezone_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="timezone_modal_label" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="timezone_modal_label">Select your time zone</h5>
              {% if timezone %}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              {% endif %}
            </div>
            <div class="modal-body">
              <input type="hidden" id="timezone" value={{ timezone }}>
              <form id="save-timezone" class="needs-validation" method="POST" action="{{ url_for('save_timezone') }}" novalidate="">
                {{ timezone_form.hidden_tag() }}
                <select class="form-select" id="timezone" name="timezone" required="">
                {% for value, text in timezone_form.timezone.choices %}
                
                  
                  <option {% if value == timezone or timezone == '' and value=="Pacific/Auckland"  %}selected=""{% endif %} value="{{ value }}">{{ text }}</option>
              
                {% endfor %}
              </select>
            </form>
            </div>
            <div class="modal-footer">
              {% if timezone %}
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              {% endif %}
              {{ timezone_form.submit() }}
              
            </div>
          </div>
        </div>
      </div>

{% endblock content %} 

{% block body_bottom_js %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/flatpickr.min.css') }}">
<script src="{{ url_for('static', filename='js/flatpickr.min.js') }}"></script>

<script>
  flatpickr(".time", {
    enableTime: true,
    noCalendar: true,
    time_24hr: true,
    dateFormat: "H:i",
  });
  flatpickr(".cal", {
    enableTime: false,
    dateFormat: "d/m/Y",
    altInput: true,
    altFormat: "j F Y",
    static: true,
    locale: {
        firstDayOfWeek: 1
    },
{% if recurrence_type == "manual" %}
    mode: "multiple",
    inline: true,
{% endif %}
  });
  
</script>
{% if recurrence_type != "manual" %}
<script>
  let frequency = document.getElementById("frequency");
  let monthly = document.getElementById("occurrence-number-container");
  let interval_text = document.getElementById("interval-text");

  function monthly_recurrance_fields(){
       checkboxes = document.getElementsByName('days_of_week');
    for(var i=0, n=checkboxes.length;i<n;i++) {
      checkboxes[i].checked = false;
    }

    if (frequency.value == "MONTHLY")
    {
      monthly.classList.remove("d-none")
      interval_text.innerHTML = "month(s)"
    } else {
      monthly.classList.add("d-none")
      interval_text.innerHTML = "week(s)"
    }
  }

  frequency.addEventListener("change", monthly_recurrance_fields);

  window.addEventListener("load", function(){
    monthly_recurrance_fields();
    monthly_recurrance_fields();
  });

</script>
{% endif %}
<script>
let allow_cancellations_choice_2 = document.getElementById("allow_cancellations-2");

  function allow_cancellations_choice(){

      let cancellation_cutoff_number = document.getElementById("cancellation_cutoff_number");
      let cancellation_cutoff_timeunit = document.getElementById("cancellation_cutoff_timeunit");

      if (allow_cancellations_choice_2.checked){
      cancellation_cutoff_number.disabled = false;
      cancellation_cutoff_timeunit.disabled = false;
    }
    else{
      cancellation_cutoff_number.disabled = true;
      cancellation_cutoff_timeunit.disabled = true;
    }
  }
  allow_cancellations_choice_2.addEventListener("change", allow_cancellations_choice);




 function send_email_capacity_fields(){
     let send_capacity_email = document.getElementById("send_capacity_email");

     if (send_capacity_email.checked){
      send_capacity_email_cutoff_number.disabled = false;
      send_capacity_email_cutoff_timeunit.disabled = false;
    }
    else{
      send_capacity_email_cutoff_number.disabled = true;
      send_capacity_email_cutoff_timeunit.disabled = true;
    }
 }


send_capacity_email.addEventListener("change", send_email_capacity_fields);

 window.addEventListener("load", function(){
    allow_cancellations_choice();
    send_email_capacity_fields();

    var allow_cancellations = document.getElementsByName('allow_cancellations');
    allow_cancellations.forEach((input) => {
        input.addEventListener("change", function(){
            if (input.value == 2) {
                cancellation_cutoff_number.disabled = false;
                cancellation_cutoff_timeunit.disabled = false;
            }
            else{
                cancellation_cutoff_number.disabled = true;
                cancellation_cutoff_timeunit.disabled = true;
            }
        })
    });


});
  
function scrollSmoothTo(elementId) {
  var element = document.getElementById(elementId);
  element.scrollIntoView({
    block: 'start',
    behavior: 'smooth'
  });
}

let back_to_top_button = document.getElementById("btn-back-to-top");
let timezone_button = document.getElementById("btn-timezone");

// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function () {
  scrollFunction();
};

function scrollFunction() {
  if (
    document.body.scrollTop > 400 ||
    document.documentElement.scrollTop > 400
  ) {
    back_to_top_button.style.display = "block";
    timezone_button.classList.add("btn-fixed")
  } else {
    back_to_top_button.style.display = "none";
    timezone_button.classList.remove("btn-fixed")
  }
}
// When the user clicks on the button, scroll to the top of the document
back_to_top_button.addEventListener("click", backToTop);

function backToTop() {
  document.body.scrollTop = 0;
  document.documentElement.scrollTop = 0;
}

$(window).scroll(function() {
  sessionStorage.scrollTop = $(this).scrollTop();
});

$(document).ready(function() {
  if (sessionStorage.scrollTop != "undefined") {
    $(window).scrollTop(sessionStorage.scrollTop);
  }
});

</script>

<script>
          
  var timezone_modal = $('#timezone_modal')
  var timezone = $('#timezone')
  $(window).on('load', function() {
      
      if (!timezone.val()){
        timezone_modal.modal('show');
    }
});
</script>
<script>


  $(document).on('submit', 'form', function(e) {
    
    let from_url = $(this).attr("action");
    if (from_url == 'delete-events-set' || from_url == 'delete-event'){
      
      e.preventDefault();
      if (window.confirm('Delete?')){
      $.ajax({
        method: 'POST',
        url: from_url,
        data: $(this).serialize(),
        beforeSend: function() {
          $('#spinner').show();
        },
        complete: function(){
            $('#spinner').hide();
        },
        success: function(resp){
          $('#event-sets').html(resp.data)
        }
      });
    }
    }
  });

  $(document).on('submit', '#delete-rooms', function(e) {
      e.preventDefault();
      if (window.confirm('Delete rooms?')){
      $.ajax({
        method: 'POST',
        url: 'delete-rooms',
        data: $(this).serialize(),
        beforeSend: function() {
          $('#spinner').show();
        },
        complete: function(){
            $('#spinner').hide();
        },
        success: function(resp){
          $('#rooms-wrapper').html(resp.data)
        }
      });
  }
  });

  $(document).on('submit', '#delete-backup', function(e) {
    e.preventDefault();
    if (window.confirm('Delete custom fields?')){
    $.ajax({
      method: 'POST',
      url: 'delete-backup',
      data: $(this).serialize(),
      beforeSend: function() {
        $('#spinner').show();
      },
      complete: function(){
          $('#spinner').hide();
      },
      success: function(resp){
        $('#custom-fields-wrapper').html(resp.data)
      }
    });
}
});

  $(document).on('submit', '#save-timezone', function(e) {
    e.preventDefault();
      $.ajax({
        method: 'POST',
        url: '/save-timezone',
        data: $(this).serialize(),
        success: function(resp){
          $('#btn-timezone').html('Timezone: ' + resp.timezone);
          $('#event-sets').html(resp.event_sets);
        }
      });
    
  });


  $(document).on('submit', 'form', function(e) {

    let from_url = $(this).attr("action");
    message_container = $('.alert')
    if (from_url == 'create-recurring-events'){
      e.preventDefault();
      $.ajax({
        method: 'POST',
        url: from_url,
        data: $(this).serialize(),
        beforeSend: function() {
            $('#spinner').show();
         },
         complete: function(){
            $('#spinner').hide();

         },
        success: function(resp){
          message_container.addClass('alert-success').removeClass('alert-danger');
          $('#event-sets').html(resp.data);
          message_container.html(resp.message);

        },
        error: function(request,status, message){
          message_container.addClass('alert-danger').removeClass('alert-success');
          message_container.html(request.responseJSON.message)
        }

      });
    }
  });
  
</script>
{% endblock %}